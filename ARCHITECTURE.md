# Arquitetura do DRE Infinity Spark

## Vis√£o Geral

O **DRE Infinity Spark** √© uma plataforma completa de gest√£o financeira empresarial que calcula automaticamente a Demonstra√ß√£o do Resultado do Exerc√≠cio (DRE) e m√©tricas avan√ßadas de neg√≥cios.

## Fluxo de Dados

```mermaid
graph TD
    A[Usu√°rio cadastra transa√ß√£o] --> B[Backend: INSERT em transactions]
    B --> C[Trigger SQL: transactions_metrics_trigger]
    C --> D[Fun√ß√£o: calculate_and_cache_metrics]
    D --> E[Leitura de tax_configurations]
    D --> F[C√°lculo de KPIs]
    F --> G[INSERT/UPDATE em metrics_cache]
    G --> H[Frontend: Dashboard l√™ metrics_cache]
    H --> I[Visualiza√ß√£o em tempo real]
```

## Fluxo de Atualiza√ß√£o Autom√°tica de M√©tricas

**Como funciona o sistema de cache autom√°tico:**

1. **Usu√°rio cria/edita/deleta transa√ß√£o** em `/transactions`
2. **PostgreSQL trigger `transactions_metrics_trigger` dispara automaticamente** (AFTER INSERT/UPDATE/DELETE)
3. **Fun√ß√£o SQL `trigger_recalculate_metrics()` √© executada**
4. **Fun√ß√£o SQL `calculate_and_cache_metrics()` recalcula TODAS as m√©tricas:**
   - üìä CAC, LTV, LTV/CAC Ratio
   - üí∞ ROI, Average Ticket
   - ‚öñÔ∏è Break-Even Point, Safety Margin
   - üí∏ Fixed/Variable Costs, Tax Deductions
5. **Resultados s√£o salvos em `metrics_cache`** com timestamp em `last_calculated_at`
6. **Dashboard l√™ `metrics_cache` via `useMetricsCache` hook** e exibe em tempo real
7. **‚úÖ Nenhum rec√°lculo manual necess√°rio!**

**Vantagens:**
- ‚ö° Performance: Dashboard carrega instantaneamente
- üîÑ Sempre atualizado: Dados sincronizados automaticamente
- üõ°Ô∏è Consist√™ncia: C√°lculos √∫nicos no backend (evita discrep√¢ncias)

### Detalhamento do Fluxo

1. **Cadastro de Transa√ß√£o** (`/transactions`)
   - Usu√°rio cria uma transa√ß√£o com categoria, valor e data
   - O frontend valida os dados e envia ao Supabase

2. **Persist√™ncia no Banco** (`transactions` table)
   - Transa√ß√£o √© inserida com campos:
     - `company_id`, `category_id`, `amount`, `transaction_date`
     - `is_marketing_cost`, `is_sales_cost`, `is_new_client`
     - `month`, `year` (auto-populados via trigger)

3. **Trigger Autom√°tico**
   - Trigger `transactions_metrics_trigger` dispara AP√ìS INSERT/UPDATE/DELETE
   - Chama fun√ß√£o `trigger_recalculate_metrics()`

4. **C√°lculo de M√©tricas**
   - Fun√ß√£o `calculate_and_cache_metrics(company_id, month, year)`:
     - Busca `tax_configurations` para al√≠quotas corretas
     - Soma receitas, custos e despesas por categoria
     - Calcula CAC, LTV, ROI, Ponto de Equil√≠brio
     - Salva em `metrics_cache`

5. **Exibi√ß√£o no Frontend**
   - Dashboard l√™ `metrics_cache` via hook `useMetricsCache`
   - DRE l√™ via hook `useDRE`
   - Gr√°ficos e KPIs s√£o atualizados automaticamente

---

## C√°lculo da DRE

### Estrutura da DRE

```
Receita Bruta
(-) Dedu√ß√µes (Impostos)
= Receita L√≠quida
(-) CMV (Custo de Mercadoria Vendida)
= Lucro Bruto
(-) Despesas Operacionais
= Lucro Operacional (EBIT)
(-) IR/CSLL
= Lucro L√≠quido
```

### F√≥rmulas Implementadas

#### 1. Receita Bruta
```sql
SELECT SUM(amount) 
FROM transactions 
WHERE category_type = 'revenue'
```

#### 2. Dedu√ß√µes (Impostos)
```sql
-- Se usar DAS (Simples Nacional):
dedu√ß√µes = receita_bruta * das_rate

-- Sen√£o (Lucro Presumido/Real):
dedu√ß√µes = receita_bruta * (icms + ipi + pis + cofins + iss)
```
**Fonte:** `tax_configurations` table

#### 3. Receita L√≠quida
```
receita_l√≠quida = receita_bruta - dedu√ß√µes
```

#### 4. CMV (Custo de Mercadoria Vendida)
```sql
SELECT SUM(amount) 
FROM transactions 
WHERE category_type = 'cost'
```

#### 5. Lucro Bruto
```
lucro_bruto = receita_l√≠quida - cmv
```

#### 6. Despesas Operacionais
```sql
SELECT SUM(amount) 
FROM transactions 
WHERE category_type = 'expense'
```

#### 7. Lucro Operacional (EBIT)
```
lucro_operacional = lucro_bruto - despesas_operacionais
```

#### 8. Lucro L√≠quido
```
lucro_l√≠quido = lucro_operacional - ir_csll
```
*Nota: IR e CSLL s√£o calculados sobre o lucro operacional*

---

## C√°lculo de M√©tricas Avan√ßadas

### 1. CAC (Custo de Aquisi√ß√£o de Cliente)
```
CAC = (Marketing Costs + Sales Costs) / New Clients Count
```

**Exemplo:**
- Marketing: R$ 5.000
- Vendas: R$ 3.000
- Novos Clientes: 10
- **CAC = R$ 800**

**Fonte de Dados:**
- `transactions` onde `is_marketing_cost = true` OU `is_sales_cost = true`
- `transactions` onde `is_new_client = true` e `client_id IS NOT NULL`

---

### 2. LTV (Lifetime Value)
```
LTV = Average Ticket √ó 12 meses
```

**Exemplo:**
- Ticket M√©dio: R$ 1.200
- **LTV = R$ 14.400**

**Nota:** Assumimos reten√ß√£o de 12 meses (simplificado). Em produ√ß√£o, seria calculado com base no hist√≥rico real de recompra.

---

### 3. LTV/CAC Ratio
```
LTV/CAC Ratio = LTV / CAC
```

**Exemplo:**
- LTV: R$ 14.400
- CAC: R$ 800
- **Ratio = 18:1**

**Interpreta√ß√£o:**
- ‚úÖ **> 3:1** ‚Üí Saud√°vel (cliente retorna 3x o custo de aquisi√ß√£o)
- ‚ö†Ô∏è **< 3:1** ‚Üí Aten√ß√£o (pode indicar problema de reten√ß√£o ou marketing caro)

---

### 4. ROI (Return on Investment)
```
ROI = ((Net Revenue - Total Costs) / Total Costs) √ó 100
```

**Exemplo:**
- Receita L√≠quida: R$ 50.000
- Custos Totais: R$ 30.000
- **ROI = 66,7%**

---

### 5. Average Ticket (Ticket M√©dio)
```
Average Ticket = Total Revenue / Total Sales Count
```

**Exemplo:**
- Receita Total: R$ 100.000
- N√∫mero de Vendas: 50
- **Ticket M√©dio = R$ 2.000**

---

### 6. Break-Even Point (Ponto de Equil√≠brio)
```
Break-Even Point = Fixed Costs / Contribution Margin Rate

Onde:
Contribution Margin = Net Revenue - Variable Costs
Contribution Margin Rate = Contribution Margin / Net Revenue
```

**Exemplo:**
- Receita L√≠quida: R$ 100.000
- Custos Vari√°veis: R$ 40.000
- Custos Fixos: R$ 30.000
- Margem de Contribui√ß√£o: R$ 60.000
- Taxa de MC: 60%
- **Ponto de Equil√≠brio = R$ 50.000**

**Interpreta√ß√£o:** A empresa precisa faturar R$ 50.000 para cobrir todos os custos fixos.

---

### 7. Safety Margin (Margem de Seguran√ßa)
```
Safety Margin % = ((Net Revenue - Break-Even Point) / Net Revenue) √ó 100
```

**Exemplo:**
- Receita L√≠quida: R$ 100.000
- Ponto de Equil√≠brio: R$ 50.000
- **Margem de Seguran√ßa = 50%**

**Interpreta√ß√£o:** A receita pode cair 50% antes da empresa entrar no preju√≠zo.

---

## Estrutura de Banco de Dados

### Tabelas Principais

#### `transactions`
- Armazena TODAS as movimenta√ß√µes financeiras
- Campos cr√≠ticos:
  - `category_id` ‚Üí FK para `dre_categories`
  - `is_marketing_cost`, `is_sales_cost` ‚Üí Para c√°lculo de CAC
  - `is_new_client` ‚Üí Para identificar novos clientes
  - `client_id` ‚Üí FK para `clients`

#### `dre_categories`
- Define as categorias da DRE
- Tipos: `revenue`, `cost`, `expense`
- Classifica√ß√£o: `fixed`, `variable`

#### `metrics_cache`
- **Cache de m√©tricas calculadas por per√≠odo**
- Evita rec√°lculo em toda visualiza√ß√£o do Dashboard
- Atualizado automaticamente via trigger

#### `tax_configurations`
- Al√≠quotas de impostos por empresa
- `use_das` ‚Üí Se usa DAS (Simples Nacional)
- Taxas individuais: ICMS, IPI, PIS, COFINS, ISS

---

## Integra√ß√£o Backend/Frontend

### Hooks Principais

#### `useMetricsCache(month?, year?)`
- Busca m√©tricas cacheadas do backend
- Retorna: `metricsCache`, `loading`, `lastUpdated`
- Usado no **Dashboard** para KPIs

#### `useDRE(month, year)`
- Calcula DRE completa no frontend
- L√™ `transactions` e `tax_configurations`
- Usado na p√°gina **DRE/Relat√≥rios**

#### `useTaxConfigurations()`
- Busca e atualiza configura√ß√µes de impostos
- Usado em **Configura√ß√µes > % AV**

---

## M√≥dulos do Sistema

### 1. Dashboard (`/dashboard`)
- **KPIs Principais:** Lucro L√≠quido, Receita L√≠quida, CAC, LTV, ROI
- **Gr√°ficos:**
  - Evolu√ß√£o do Lucro L√≠quido (12 meses)
  - Funil de Composi√ß√£o da Receita
  - Evolu√ß√£o de CAC e LTV
  - Indicadores de Metas

### 2. DRE/Relat√≥rios (`/reports`)
- DRE completa com An√°lise Vertical (% AV)
- An√°lise Horizontal (% AH) - compara√ß√£o mensal
- Exporta√ß√£o para Excel

### 3. Lan√ßamentos (`/transactions`)
- Cadastro de transa√ß√µes
- Filtros por per√≠odo, categoria, cliente
- Marca√ß√£o de custos de marketing/vendas

### 4. Metas e Or√ßamento (`/goals`)
- Defini√ß√£o de metas por m√©trica
- Compara√ß√£o Realizado vs Meta
- Indicadores de progresso

### 5. Ponto de Equil√≠brio (`/break-even`)
- C√°lculo de Break-Even Point
- Gr√°fico de Margem de Seguran√ßa
- An√°lise de Contribui√ß√£o Marginal

### 6. Cen√°rios (`/scenarios`)
- Simula√ß√£o de aumento/redu√ß√£o de receitas
- Simula√ß√£o de aumento/redu√ß√£o de custos
- Proje√ß√µes de impacto no lucro

### 7. Configura√ß√µes (`/settings`)
- **Conta:** Edi√ß√£o de dados da empresa
- **% AV (An√°lise Vertical):** Configura√ß√£o de al√≠quotas
- Gest√£o de m√∫ltiplas empresas

---

## Seguran√ßa e RLS (Row-Level Security)

### Pol√≠ticas Implementadas

#### `transactions`
```sql
-- Usu√°rios s√≥ veem transa√ß√µes de suas empresas
WHERE EXISTS (
  SELECT 1 FROM companies 
  WHERE companies.id = transactions.company_id 
  AND companies.owner_id = auth.uid()
)
```

#### `metrics_cache`
```sql
-- Apenas leitura, inser√ß√£o via trigger SQL
POLICY FOR SELECT WHERE company_owner = auth.uid()
```

#### `tax_configurations`
```sql
-- Usu√°rios podem editar configura√ß√µes de suas empresas
POLICY FOR ALL WHERE company_owner = auth.uid()
```

---

## Performance e Otimiza√ß√µes

### 1. Cache de M√©tricas
- **Problema:** Recalcular m√©tricas em toda visualiza√ß√£o √© lento
- **Solu√ß√£o:** Tabela `metrics_cache` atualizada via trigger
- **Benef√≠cio:** Dashboard carrega instantaneamente

### 2. √çndices no Banco
```sql
CREATE INDEX idx_transactions_company_period 
ON transactions(company_id, month, year);

CREATE INDEX idx_transactions_category 
ON transactions(category_id);
```

### 3. React.memo e useMemo
- Componentes de gr√°fico usam `React.memo` para evitar re-renders
- C√°lculos pesados usam `useMemo` para cachear resultados

---

## Troubleshooting

### Dashboard Vazio ou Desatualizado

**Sintoma:** Dashboard n√£o exibe dados ap√≥s cadastrar transa√ß√µes

**Causa:** `metrics_cache` n√£o foi atualizado

**Solu√ß√£o:**
1. Ir para `/debug-data`
2. Clicar em "üîÑ Recalcular M√©tricas"
3. Verificar se `last_calculated_at` foi atualizado

---

### Transa√ß√µes Sem Categoria

**Sintoma:** Transa√ß√µes n√£o aparecem na DRE

**Causa:** `category_id` √© NULL

**Solu√ß√£o:** Migration SQL cria categorias padr√£o e atualiza transa√ß√µes √≥rf√£s

---

### Impostos Errados

**Sintoma:** Dedu√ß√µes n√£o batem com o esperado

**Causa:** `tax_configurations` n√£o est√° configurado corretamente

**Solu√ß√£o:**
1. Ir para **Configura√ß√µes > % AV**
2. Ajustar as al√≠quotas corretas
3. Clicar em "Recalcular M√©tricas" no Debug

---

## Roadmap Futuro

### Curto Prazo
- [ ] Integra√ß√£o com bancos (Open Banking)
- [ ] Importa√ß√£o de XML/NFe
- [ ] Relat√≥rios em PDF

### M√©dio Prazo
- [ ] Multi-moeda
- [ ] Fluxo de caixa projetado
- [ ] An√°lise de tend√™ncias com IA

### Longo Prazo
- [ ] Mobile app (React Native)
- [ ] Gest√£o de estoque
- [ ] CRM integrado

---

## Contato e Suporte

Para d√∫vidas ou suporte t√©cnico:
- üìß Email: suporte@infinityspark.com.br
- üí¨ Discord: [link]
- üìö Documenta√ß√£o: https://docs.infinityspark.com.br
